#!/usr/bin/env python
"""
Fit the COSMOS (Tertiary 23) tiles:

https://desi.lbl.gov/trac/wiki/SurveyOps/TertiaryPrograms#TertiaryPrograms

time /global/u2/i/ioannis/code/desihub/fastspecfit-projects/tertiary23/fastspecfit-tertiary23 --mp 128 
time /global/u2/i/ioannis/code/desihub/fastspecfit-projects/tertiary23/fastspecfit-tertiary23 --mp 128 --merge

time /global/u2/i/ioannis/code/desihub/fastspecfit-projects/tertiary23/fastspecfit-tertiary23 --mp 128 --fastphot
time /global/u2/i/ioannis/code/desihub/fastspecfit-projects/tertiary23/fastspecfit-tertiary23 --mp 128 --fastphot --merge

"""
import pdb # for debugging

import os, time, subprocess
from glob import glob
import numpy as np
import fitsio
from astropy.table import Table, Table, vstack

from desiutil.log import get_logger
log = get_logger()

def main():
    """Main wrapper

    """
    import argparse    

    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument('--mp', type=int, default=1, help='Number of multiprocessing processes per MPI rank or node.')
    parser.add_argument('-n', '--ntargets', type=int, help='Number of targets to process in each file.')
    parser.add_argument('--outdir', type=str, default='/global/cfs/cdirs/desi/users/ioannis/tertiary23', help='Output directory.')
    parser.add_argument('--datadir', type=str, default='/global/cfs/cdirs/desi/users/raichoor/laelbg/daily/healpix/tertiary23-thru20230326',
                        help='Input data directory.')
    parser.add_argument('--targetids', type=str, default=None, help='Comma-separated list of TARGETIDs to process.')
    parser.add_argument('--fastphot', action='store_true', help='Fit just the broadband photometry.')
    parser.add_argument('--overwrite', action='store_true', help='Overwrite existing files.')
    parser.add_argument('--nolog', action='store_true', help='Do not write a log (useful for debugging).')
    parser.add_argument('--merge', action='store_true', help='Merge all individual catalogs into one large file.')
    parser.add_argument('--makeqa', action='store_true', help='Build QA in parallel.')
    parser.add_argument('--makehtml', action='store_true', help='Build the HTML page.')
    args = parser.parse_args()

    if args.fastphot:
        fcmd = 'fastphot'
        prefix = 'fastphot-'
        outdir = os.path.join(args.outdir, 'fastphot')
    else:
        fcmd = 'fastspec'
        prefix = 'fastspec-'
        outdir = os.path.join(args.outdir, 'fastspec')

    if not os.path.isdir(outdir):
        os.makedirs(outdir, exist_ok=True)

    if args.merge:
        from fastspecfit.mpi import _domerge

        mergefile = os.path.join(args.outdir, f'{prefix}tertiary23.fits')
        if not os.path.isfile(mergefile) and not args.overwrite:
            fastfiles = glob(os.path.join(outdir, f'{prefix}?????.fits*'))
            _domerge(fastfiles, extname=fcmd.upper(), mergefile=mergefile,
                     fastphot=args.fastphot, mp=args.mp)
        else:
            print(f'Output file {mergefile} exists; use --overwrite to, well, overwrite.')
    elif args.makeqa:
        raise NotImplementedError
    elif args.makehtml:
        raise NotImplementedError
    else:
        # fit!
        redrockfiles = glob(os.path.join(args.datadir, 'redrock-?????.fits'))
        for redrockfile in redrockfiles:
            fastfile = os.path.join(outdir, os.path.basename(redrockfile).replace('redrock-', prefix))
            if not args.fastphot:
                fastfile += '.gz'
                
            if not os.path.isfile(fastfile) and not args.overwrite:
                cmd = f'{fcmd} {redrockfile} -o {fastfile} --mp {args.mp}'
                if args.ntargets:
                    cmd += ' --ntargets {}'.format(args.ntargets)
                if args.targetids:
                    cmd += ' --targetids {}'.format(args.targetids)
                print(cmd)
                if args.nolog:
                    err = subprocess.call(cmd.split())
                else:
                    logfile = fastfile.replace('.fits', '.log').replace('.gz', '')
                    with open(logfile, 'w') as mylog:
                        err = subprocess.call(cmd.split(), stdout=mylog, stderr=mylog)
            else:
                print(f'Output file {fastfile} exists and --overwrite not set.')

if __name__ == '__main__':
    main()
